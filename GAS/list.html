<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <?!= include('GAS/css'); ?>
  </head>
  <header>
    <h1>書籍管理</h1>
  </header>
  <body>
    <form>
      <p><label>検索</label><br>
      <input id="bnameid" class="bname" type="text" name="bookname" size="40" placeholder="書籍名の文字列検索">  
      <select id="whereaboutsid" name="whereabouts">
      <option value="0">所在検索</option>
      <option value="1">福井</option>
      <option value="2">東京</option>
      <option value="3">沖縄</option>
      </select>
      <input type="button" name="search" value="検索" onclick="makeTable()">
      <input type="button" name="clerr" value="検索条件クリア">
      <input type="button" name="regist" value="新規登録" onclick="onClickRegist()"></p>
    </form>

    <div id = "dvTable" />
   <script>
      function makeTable() {
        // テキストボックスの入力値を取得する
        const paramete1 = document.getElementById('bnameid').value;
        const paramete2 = document.getElementById('whereaboutsid').value;

        // データを取得する
        google.script.run.withSuccessHandler(function(data) {

          const tableId = "tId";
          //Table clear
          if (document.getElementById(tableId)) document.getElementById(tableId).remove();

          //Create a HTML Table element.
          var table = document.createElement("table");
          table.id = tableId; //Add TableId
          table.border = "1";
  
          //Get the count of columns.
          var columnCount = data[0].length;
  
          //Add the header row.
          var row = table.insertRow(-1);
          for (var i = 0; i < columnCount-4; i++) {
            var headerCell = document.createElement("TH");
            headerCell.setAttribute("class","header"+(i+1));
            headerCell.innerHTML = data[0][i];
            if(i===3) headerCell.setAttribute("colspan", "3");
            row.appendChild(headerCell);
          }
          var headerCell = document.createElement("TH");
          headerCell.setAttribute("class","header"+(i+1));
          headerCell.innerHTML = "編集";
          row.appendChild(headerCell);

          var headerCell = document.createElement("TH");
          headerCell.setAttribute("class","header"+(i+2));
          headerCell.innerHTML = "削除";
          row.appendChild(headerCell);
  
          //Add the data rows.
          for (var i = 1; i < data.length; i++) {
            row = table.insertRow(-1);
            for (var j = 0; j < columnCount-2; j++) {
              var cell = row.insertCell(-1);
              cell.setAttribute("class","data"+(j+1));
              if(j === 0) {
                var anchor = document.createElement("a");
                anchor.href = data[i][6];
                var str = document.createTextNode(data[i][j]);
                anchor.appendChild(str);
                cell.appendChild(anchor);
                continue;
              }
              if(j === 3) {
                if(data[i][j] === 1) {
                  cell.innerHTML = "貸出中";
                } else {
                  var btn = document.createElement("button"); 
                  btn.type = "button";
                  // btn.onclick = function() {alert('OnClick')};
                  btn.onclick = function() {onClickLend(1,google.script.run.getUser(),"")};
                  // btn.onclick = function() {google.script.run.statUpdate(1,google.script.run.getUser(),"")};
                  var submit = document.createTextNode("貸出");
                  btn.appendChild(submit);
                  cell.appendChild(btn);
                }
                continue;
              }
              if (data[i][j] === "") continue;
              cell.innerHTML = data[i][j];
            }
            // 編集ボタン
            var cell = row.insertCell(-1);
            cell.setAttribute("class","data"+(j+1));
            var btn = document.createElement("button"); 
            btn.type = "button";
            var submit = document.createTextNode("編集");
            btn.appendChild(submit);
            cell.appendChild(btn);
            // 削除ボタン
            var cell = row.insertCell(-1);
            cell.setAttribute("class","data"+(j+2));
            var btn = document.createElement("button"); 
            btn.type = "button";
            var submit = document.createTextNode("削除");
            if(data[i][3] === 1) btn.setAttribute("disabled","disabled");
            btn.appendChild(submit);
            cell.appendChild(btn);
          }
          var dvTable = document.getElementById("dvTable");
          // dvTable.innerHTML = "";
          dvTable.appendChild(table);

        }).withFailureHandler(function(e) {
          // データの取得に失敗した場合
          alert(e);

        }).getData(paramete1,paramete2);
      }
      // 初期表示時の処理
      makeTable();

      function onClickRegist() {
        google.script.run.withSuccessHandler(function(myUrl){window.top.location.href= myUrl + "?p=regist";}).getURL();          
      }

      function onClickLend(stat, user, row) {
        console.log("oooo");
        google.script.run.getUser();          
        google.script.run.statUpdate(stat, user, row);
      }

    </script>
  </body>
</html>
